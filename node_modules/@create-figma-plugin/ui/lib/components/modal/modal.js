import { Fragment, h, render } from 'preact';
import { useEffect, useRef } from 'preact/hooks';
import { IconCross32 } from '../../icons/icon-32/icon-cross-32';
import { createClassName } from '../../utilities/create-class-name';
import { createFocusTrapKeyDownHandler } from '../../utilities/private/create-focus-trap-key-down-handler';
import { getFocusableElements } from '../../utilities/private/get-focusable-elements';
import { IconButton } from '../icon-button/icon-button';
import { Text } from '../text/text';
import styles from './modal.module.css';
const rootElements = [];
export function Modal({ children, closeButtonIcon = h(IconCross32, null), closeButtonPosition = "right", open, noTransition = false, onCloseButtonClick, onEscapeKeyDown, onOverlayClick, position = "center", title, ...rest }) {
    const rootElementRef = useRef(null);
    const previousFocusedElementRef = useRef(null);
    useEffect(function () {
        const rootElement = document.createElement("div");
        document.body.appendChild(rootElement);
        rootElementRef.current = rootElement;
        return function () {
            document.body.removeChild(rootElement);
        };
    }, []);
    useEffect(function () {
        if (rootElementRef.current === null) {
            throw new Error("`rootElementRef.current` is `null`");
        }
        const focusTrapKeyDownHandler = createFocusTrapKeyDownHandler(rootElementRef.current);
        function handleTabKeyDown(event) {
            if (open === true) {
                focusTrapKeyDownHandler(event);
            }
        }
        window.addEventListener("keydown", handleTabKeyDown);
        return function () {
            window.removeEventListener("keydown", handleTabKeyDown);
        };
    }, [open]);
    useEffect(function () {
        function handleEscapeKeyDown(event) {
            if (open === false ||
                event.key !== "Escape" ||
                typeof onEscapeKeyDown === "undefined" ||
                rootElements[rootElements.length - 1] !== rootElementRef.current) {
                return;
            }
            onEscapeKeyDown(event);
        }
        window.addEventListener("keydown", handleEscapeKeyDown);
        return function () {
            window.removeEventListener("keydown", handleEscapeKeyDown);
        };
    }, [open, onEscapeKeyDown]);
    useEffect(function () {
        if (rootElementRef.current === null) {
            throw new Error("`rootElementRef.current` is `null`");
        }
        if (open === true) {
            rootElements.push(rootElementRef.current);
            rootElementRef.current.style.cssText =
                "position:absolute;top:0;left:0;bottom:0;right:0;z-index:1";
            previousFocusedElementRef.current =
                document.activeElement;
            const focusableElements = getFocusableElements(rootElementRef.current);
            if (focusableElements.length > 0) {
                focusableElements[0].focus();
            }
            else {
                previousFocusedElementRef.current.blur();
            }
        }
        else {
            rootElements.pop();
            rootElementRef.current.style.cssText = "position:static";
        }
        return function () {
            if (previousFocusedElementRef.current !== null) {
                previousFocusedElementRef.current.focus();
            }
        };
    }, [open]);
    useEffect(function () {
        if (rootElementRef.current === null) {
            throw new Error("`rootElementRef.current` is `null`");
        }
        render(h(Fragment, null, h("div", { ...rest, class: createClassName([
                styles.modal,
                open === true ? styles.open : null,
                noTransition === true ? styles.noTransition : null,
                styles[position]
            ]) }, children, typeof onCloseButtonClick === "undefined" &&
            typeof title === "undefined" ? null : (h("div", { class: styles.topBar }, h("div", { class: styles.title }, typeof title === "undefined" ? null : (h(Text, null, h("strong", null, title)))), typeof onCloseButtonClick === "undefined" ? null : (h("div", { class: closeButtonPosition === "left"
                ? styles.closeButtonLeft
                : undefined }, h(IconButton, { onClick: onCloseButtonClick }, closeButtonIcon)))))), h("div", { class: styles.overlay, onClick: typeof onOverlayClick === "undefined" ? undefined : onOverlayClick })), rootElementRef.current);
    }, [
        children,
        closeButtonIcon,
        closeButtonPosition,
        noTransition,
        onCloseButtonClick,
        onOverlayClick,
        open,
        position,
        rest,
        title
    ]);
    return null;
}
//# sourceMappingURL=modal.js.map